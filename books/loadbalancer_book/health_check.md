---
title: "ヘルスチェック"
---

## ヘルスチェック
本記事では、Webサーバであるnginxにおけるヘルスチェックについて紹介します。
ヘルスチェックとは、ロードバランサがサーバの動作状態を監視し、サーバに障害が発生していた場合には、該当のサーバにリクエストを振り分けないようにする機能です。
ヘルスチェックには、アクティブヘルスチェックとパッシブヘルスチェックという2種類の方式が存在します。

### アクティブヘルスチェック
ロードバランサ自身が動的にサーバのチェックを行う方式です。クライアントの通信を行う前にサーバの障害を検知することができます。
動作原理としては、定期的にサーバへリクエストを送信し、正しい応答があるかどうかを確認します。これにより、サーバの障害を検知した場合にはリクエストの振り分け先から除外し、残りのサーバでリクエストを処理をします。
サーバダウン後も定期的にヘルスチェックを行うため、サーバが復旧し、ヘルスチェックに合格すると、ダウンしていたサーバは自動的にリクエストの振り分け先に戻ることができます。
nginxにおけるアクティブヘルスチェックはNginx Pulsという有料版の機能となっています。

### パッシブヘルスチェック
ロードバランサが静的にサーバの状態をチェックを行う方式です。
動作原理としては、クライアントからのリクエストに対するサーバの応答をチェックすることでサーバの障害を検知することができます。そのため、実際に通信障害が発生するまでサーバの障害を検知することができません。また、障害発生してから一定時間が経過すると、ダウンしたサーバは自動的にリクエストの振り分け先に復帰されるため、リクエストが障害が発生しているサーバに振り分けられてしまう可能性があります。
ただし、復帰させる際には1リクエストだけを流し、その応答から障害が継続しているようであれば、再びリクエストの振り分け先から除外します。
nginxでは、このパッシブヘルスチェックが無償で利用可能となっています。


## 演習
配布しているファイルを用いて、パッシブヘルスチェックが実装できるように構成されています。

実装の環境はDocker上で再現します。
構成としては
- docker-compose.yml
- nginx.conf
- server1
    - Dockerfile
    - index.html
- server2
    - Dockerfile
    - index.html
- server3
    - Dockerfile
    - index.html

 となり、今回記述するところは`nginx.conf`です。
 このnginxの設定ファイルに詳細を設定すると、パッシブヘルスチェックが実行できます。

### nginx.confの記述
パッシブヘルスチェックを実行できるように設定を実装します。
今回の実装条件として、
- サーバへの接続失敗回数が2回以上の時に障害が発生
- 障害が発生したサーバがリクエストの振り分け先からは30秒間除外
- サーバへの接続のタイムアウトを3秒

と定義する。
この条件でパッシブヘルスチェックを実装します。

:::details 解答例
以下はnginxでパッシブヘルスチェックを実装した際の設定例です。
実装の詳細は、環境や要件に応じて適宜調整してください。

```nginx.conf
events{}

http{
        upstream backend{
                server server1:80 max_fails=2 fail_timeout=30s;
                server server2:80 max_fails=2 fail_timeout=30s;
                server server3:80 max_fails=2 fail_timeout=30s;
        }

        server{
                listen 80;
                error_log /var/log/nginx/error.log warn;

                location / {
                        proxy_pass http://backend;
                        proxy_set_header Host $http_host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                        proxy_next_upstream error timeout;
                        proxy_next_upstream_tries 2;
                        proxy_next_upstream_timeout 3s;
                        proxy_send_timeout 3s;
                        proxy_connect_timeout 3s;
                        proxy_read_timeout 3s;
                }
        }
}
```
:::

### 実行動作
上記で実装した`nginx.conf`で実行結果を確認します。

#### 通常状態での実行
`docker-compose`ですべてのコンテナを起動します。
すべてのサーバが正常に動作している状態で`localhost`にブラウザからアクセスをしてみます。

:::details 実行例
コンテナを起動し、動作させる実行例です。
詳細は、環境や要件に応じて適宜調整してください。

```sh
docker-compose up -d --build
```
このコマンドですべてのコンテナを起動させます。
ブラウザに`http://localhost`を打ち込み、アクセスをします。
画面には応答しているサーバの種類が表示され、リロードを繰り返すと順番に変化するラウンドロビンが確認できます。
:::

#### 障害発生時の実行
通常状態での実行から1つのサーバのコンテナを停止させ、疑似的なサーバ障害を起こします。
これにより、パッシブヘルスチェックの効果を確認することができます。
:::details 実行例
パッシブヘルスチェックの動作を確認する実行例です。
詳細は、環境や要件に応じて適宜調整してください。

通常時のラウンドロビンが確認できる状態から、サーバのコンテナを停止させます。
`docker desktop`の画面から`server1-1`のコンテナをstopボタンを押す
または
```sh
docker stop nginx-load-balancer-healthcheck-server1-1
```
コマンドで該当のコンテナを停止させます。
この状態で`localhost`にアクセスをする。

`server3`から`server1`に変化する際に3秒の遅延が発生し、`server1`が応答せずに`504 Gateway Time-out`が表示される。
この反応が2度起こると、次からは`server1`自体にアクセスが送られず、`server2`と`server3`のみが応答するようになる。
30秒間この状態が続き、その後は再び`server1`にアクセスが送られるが、コンテナは停止したままのため`504 Gateway Time-out`が表示される。以降は`server2`と`server3`のみが応答する状態に戻り、繰り返される。
:::

#### 障害復旧時の実行
1つのサーバのコンテナを停止させた疑似的なサーバ障害を発生させた状態から、コンテナを再び起動させて応答するようにします。
これにより、サーバが復旧した際の自動復帰を確認できます。
:::details 実行例
サーバ復旧時の動作を確認する実行例です。
詳細は、環境や要件に応じて適宜調整してください。

サーバコンテナを停止させ、`504 Gateway Time-out`が表示される状態から、コンテナを起動します。
`docker desktop`の画面から`server1-1`のコンテナをstartボタンを押す
または
```sh
docker start nginx-load-balancer-healthcheck-server1-1
```
コマンドで該当のコンテナを起動させます。
この状態で`localhost`にアクセスをする。

通常状態と同じ動作が確認できます。
リロードを行うと、`server1`から`server2`、`server3`へとラウンドロビンが確認できます。
:::

## まとめ
本記事では、nginxにおけるヘルスチェックをパッシブヘルスチェックの実装例とともに解説しました。
- **アクティブヘルスチェック**:ロードバランサ自体が動的にサーバの状態をチェックし、障害を検知する。
- **パッシブヘルスチェック**:クライアントの通信の応答からサーバの状態をチェックし、障害を検知する。

ヘルスチェックは適切に導入することで、障害検知や自動切り替えが可能となり、サービスの安定性を高められます。

